;$(function(){Chart.Scale=Chart.Scale.extend({calculateX:function(index){if(!(this.valuesCount)){return 0;}
var isRotated=(this.xLabelRotation>0),innerWidth=this.width-(this.xScalePaddingLeft+this.xScalePaddingRight),valueWidth=innerWidth/(this.valuesCount-((this.offsetGridLines)||this.valuesCount===1?0:1)),valueOffset=(valueWidth*index)+this.xScalePaddingLeft;if(this.offsetGridLines){valueOffset+=(valueWidth/2);}
return Math.round(valueOffset);},});var TYPE_FLOAT=0;var TYPE_STR=1;var TYPE_BOOL=2;var TAX_YES=1;var TAX_NO=0;var TAX_PAYMENT=2;var targetWeekSel="#targetWeekSel";var actualWeekSel="#actualWeekSel";let startWeekSel="#startWeekSel";let endWeekSel="#endWeekSel";var targetSaveBtn="#targetSaveBtn";var targetInput=".input-target";var actualInput=".input-actual";$("select.input-actual").selectedIndex=-1;var focusData={};var targetFocusData={};var targetWeek=$(targetWeekSel).val();var actualWeek=$(actualWeekSel).val();$(actualInput).keypress(function(e){if(e.keyCode==13){updateData(this);}});$("input"+actualInput).focusin(function(e){var k=$(this).attr("data-number");focusData[k]=$(this).val();});$("input"+actualInput).focusout(function(e){var k=$(this).attr("data-number");var val=$(this).val();if(k in focusData){if(focusData[k]!=val){updateData(this);}}
delete focusData[k];});$(targetInput).keypress(function(e){if(e.keyCode==13){saveTargetData(this);}});$("input"+targetInput).focusin(function(e){var k=$(this).attr("data-number");targetFocusData[k]=$(this).val();});$("input"+targetInput).focusout(function(e){var k=$(this).attr("data-number");var val=$(this).val();if(k in targetFocusData){if(targetFocusData[k]!=val){saveTargetData(this);}}
delete targetFocusData[k];});$("select"+targetInput).change(function(e){saveTargetData(this);});$("select"+actualInput).change(function(e){updateData(this);});$(actualWeekSel).change(function(e){loadWeekData(this.value,actualInput);$.cookie("numbers_week",this.value,{expires:1});});$(targetWeekSel).change(function(e){loadWeekData(this.value,targetInput,true);targetWeek=this.value;$.cookie("targets_week",this.value,{expires:1});});$(startWeekSel).change(function(e){$("#exportLink").attr('href','/numbers/export?startWeek='+this.value+'&endWeek='+$(endWeekSel).val());});$(endWeekSel).change(function(e){$("#exportLink").attr('href','/numbers/export?startWeek='+$(startWeekSel).val()+'&endWeek='+this.value);});let saveTargetData=function(targetInput){var value=$(targetInput).val().replace(/,/g,"");var data=[{"id":$(targetInput).attr("data-number"),"target":value}];$(targetInput).prop('disabled',true);$.ajax({url:"/api/1/numbers/"+targetWeek,type:'PUT',contentType:'application/json',data:JSON.stringify(data),success:function(r){$(targetInput).prop('disabled',false);},error:function(e){alert("Error while processing data: "+value+". Please, check if it is a valid input value.");}});};$("#importWeekBtn").click(function(e){var fromWeek=$("#importFromWeekSel").val();var toWeek=$("#importToWeekSel").val();var startWeek=$("#targetWeekSel").val();if(startWeek==fromWeek){alert("Can't import as start week equals to import data from week.");return;}
if(toWeek<fromWeek){alert("Import 'to' week must be greater than 'from' week.");return;}
$.get("/api/1/numbers/import/"+startWeek+"/"+fromWeek+"/"+toWeek,function(r){var str_range="range of weeks "+r.from+" - "+r.to;if(r.from==r.to){str_range="week "+r.from;}
alert(r.from+" targets have been copied successfully, into "+str_range);location.reload();});});function updateData(input){var id=$(input).attr("data-number");var value=$(input).val().replace(/,/g,"");var type=$(input).attr("data-type");var week=$(actualWeekSel).val();data=[{"id":id,"actual":value}];$(input).prop('disabled',true);$.ajax({url:"/api/1/numbers/"+week,type:'PUT',contentType:'application/json',data:JSON.stringify(data),success:function(r){loadWeekData(week,actualInput,false,function(){$(input).prop('disabled',false);});}});}
function loadWeekData(week,input_name,is_target_only,callback){$.get('/api/1/numbers/'+week,function(r){$(input_name).val("");var week_data=r.week;var numbers=r.numbers;for(var i=0;i<numbers.length;i++){var number=numbers[i];var target_value=number.value!=null?number.value.target_value:null;var actual_value=number.value!=null?number.value.actual_value:null;var variance=number.value!=null?number.value.variance:null;var target_symbol=number.target_symbol;var actual_symbol=number.actual_symbol;var variance_symbol=number.variance_symbol;var variance_val=$(".variance-"+number.id);var variance_sel=$(".var-"+number.id+"-col");$(variance_sel).removeClass("red").removeClass("green");var selector=input_name+"[data-number="+number.id+"]";var number_type=number.number_type;var is_negative_green=number.is_negative_green;if(number_type==TYPE_FLOAT){if(target_value!=null&&target_value>0)
target_value=number.value.target_value;if(actual_value!=null&&actual_value>0)
actual_value=number.value.actual_value;if(variance!=null&&variance>0)
variance=number.value.variance;}else if(number_type==TYPE_BOOL){if(target_value!=null){if(target_value==TAX_YES){target_value="Yes";}else if(target_value==TAX_NO){target_value="No";}else if(target_value==TAX_PAYMENT){target_value="Payment Plan";}}}
if(is_target_only){$(selector).val(target_value);if(number_type==TYPE_BOOL&&target_value!=null){$(selector+" > option:selected").removeAttr("selected");var target_text=number.value.target_value;$(selector+" > option").each(function(){if($(this).attr("name")==target_text){$(this).prop("selected",true)}});}}else{if(number.is_formula){$(selector).text(actual_value?actual_value:'');}else{$(selector).val(actual_value);}
$(".target-"+number.id).text(target_value?target_value:"");if(number_type==TYPE_BOOL&&actual_value!=null){$(selector+" > option:selected").removeAttr("selected");var actual_text=actual_value;$(selector+" > option").each(function(){if($(this).attr("name")==actual_text){$(this).prop("selected",true)}});}
if(variance&&number_type==TYPE_FLOAT){if(is_negative_green){$(variance_sel).addClass(variance<0?"green":"red");}else{$(variance_sel).addClass(variance>=0?"green":"red");}}
$(variance_val).text(variance?variance:"");}}
if(!is_target_only){$('.year-week').text(week_data.index);$('.current-week').text(week_data.sunday);}
if(callback){callback();}});}
function buildChart(is_bar){var number=$("#numberIdSel").val();var week=$("#startWeekSel").val();var period=$("#periodSel").val();var endWeek=$("#endWeekSel").val();var chartContainer=$("#chartContainer");function getChart(){$(chartContainer).empty();var w=$(chartContainer).width();$(chartContainer).append("<canvas id='chartElm' height='400' width='"+w+"'/>");return document.getElementById("chartElm").getContext("2d");}
$.get("/api/1/number/"+number+"/"+week+"/"+endWeek+"?period="+period,function(r){var x_values=[];var target_numbers=[];var actual_numbers=[];var number_id=r.number_id;var actual_symbol=r.actual_symbol;var target_symbol=r.target_symbol;var symbol=target_symbol==actual_symbol?target_symbol:"";if(!symbol)symbol="";var description=r.description;$(".legend-description").text(description);$(".legend").removeClass("hidden");for(var i=0;i<r.results.length;i++){x_values.push(r.results[i].x_value_name);target_numbers.push(r.results[i].target_value);actual_numbers.push(r.results[i].actual_value);}
var options={bezierCurve:false,scaleShowGridLines:true,multiTooltipTemplate:"<%= datasetLabel %>: "+symbol+"<%= value %>",scaleLabel:" "+symbol+"<%=value%>",scaleFontSize:12,};var data={labels:x_values,datasets:[{label:"Target ",fillColor:"rgba(0,0,0,0.2)",strokeColor:"rgba(0,0,0,1)",pointColor:"rgba(0,0,0,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(0,0,0,1)",data:target_numbers,},{label:"Actual ",fillColor:"rgba(114,190,73,0.2)",strokeColor:"rgba(114,190,73,1)",pointColor:"rgba(114,190,73,1)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:"rgba(114,190,73,1)",data:actual_numbers}]};if(is_bar){var chart=new Chart(getChart()).Bar(data,options);}else{var chart=new Chart(getChart()).Line(data,options);}});}
$("#buildChart").click(function(){buildChart();$(".chart-types").removeClass('hidden');});$(".chart-type-line").click(function(){buildChart();});$(".chart-type-bar").click(function(){buildChart(true);});$(".next-week").click(function(){var nextElm=$(actualWeekSel+" > option:selected").next("option");if(nextElm.length>0){$(actualWeekSel+" > option:selected").removeAttr('selected').next('option').attr('selected','selected');}});$(".prev-week").click(function(){var prevElm=$(actualWeekSel+" > option:selected").prev("option");if(prevElm.length>0){$(actualWeekSel+" > option:selected").removeAttr('selected').prev('option').attr('selected','selected');}});function preloadNumbers(){if($(actualWeekSel).length>0){loadWeekData(actualWeek,actualInput,false,function(){});}}
preloadNumbers();});